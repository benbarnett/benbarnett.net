---
layout: post
title: Export SVG from Raphael JS to create a PNG bitmap
categories:
- Techniques
tags: []
status: publish
type: post
published: true
meta: {}
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h2>Update</h2>
<p>I'm very pleased to be able to say that <a href="http://github.com/jspies" target="_blank">Jonathan Spies</a> has taken the roots of this blog post and produced a <a href="http://github.com/jspies/raphael.serialize" target="_blank">fully fledged plugin</a>. I've used it on a couple of projects already. Oh how I love the web sometimes.</p>
<p><a href="http://github.com/jspies/raphael.serialize" target="_blank">http://github.com/jspies/raphael.serialize</a></p>
<h2>Introduction</h2>
<p>I’ve been playing around with RaphaelJS recently (if you haven’t seen it, <a href="http://raphaeljs.com/" target="_blank">check it out</a>) for an ‘avatar builder’ type project to avoid the use of Flash. It’s a really fun bit of kit to use, but I needed a way to actually save the results of the avatar to a bitmap to avoid having heavy javascript libraries every time the avatar is displayed on a page. After a bit of poking around on forums/blogs I thought I’d tie up all the key pieces in one blog post in case anyone else was in the same boat.</p>
<p>The output is essentially a PNG-24 alpha channel bitmap image, which can then be treated as normal with the likes of ImageMagick (I’ve been adding drop shadows to the avatars for example).</p>
<h2><strong>Extracting <strong>SVG</strong> data from <strong>Raphael</strong></strong></h2>
<p>Unfortunately this isn’t as easy as could be. In browsers that support <strong>SVG</strong>, we can simply extract all the data from the DOM itself to reproduce it, but as <strong>Raphael</strong> uses VML on non-<strong>SVG</strong> browsers (namely, IE) that idea won’t work.</p>
<p>However, the <strong>Raphael</strong> Javascript object does store the data we need in order to <em>re-produce </em>the <strong>SVG</strong>. This requires a little bit of Javascript, and for demonstration purposes I’m using PHP.</p>
<h3>The Javascript</h3>
<p>So the first thing I do build up a JSON object describing the data needed to produce the <strong>SVG</strong> file, with a little help from jQuery. I’ve put the code for this on <a href="http://gist.github.com/423856" target="_blank">this gist</a>. It essentially loops through the ‘paper’ variable that RaphaelJS is using to build up our own array. In mine I was using just paths and images, so that was the only data I needed, however this could easily be expanded to include all the other properties as well.</p>
<h3>The Server Side Code (PHP)</h3>
<p>All this file does is decode the JSON data into an associative array for use in PHP, loop through the properties and outputs an SVN file. I’ve put the PHP I’m using below as there’s not much to it:</p>
<div class="wp_syntax">
<div class="code">
<pre class="php" style="font-family: monospace;">    <span style="color: #000088;">$json</span> <span style="color: #339933;">=</span> <span style="color: #990000;">json_decode</span><span style="color: #009900;">(</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'json'</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>

    <span style="color: #000088;">$output</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'&lt;<strong>svg</strong> xmlns="http://www.w3.org/2000/<strong>svg</strong>" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'width'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" height="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'height'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" xml:space="preserve"&gt;&lt;desc&gt;Created with <strong>Raphael</strong>&lt;/desc&gt;&lt;defs&gt;&lt;/defs&gt;'</span><span style="color: #339933;">;</span>

    <span style="color: #b1b100;">for</span> <span style="color: #009900;">(</span><span style="color: #000088;">$i</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span> <span style="color: #000088;">$i</span> <span style="color: #339933;">&amp;</span>lt<span style="color: #339933;">;</span> <span style="color: #990000;">count</span><span style="color: #009900;">(</span><span style="color: #000088;">$json</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> <span style="color: #000088;">$i</span><span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'type'</span><span style="color: #009900;">]</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">"image"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
            <span style="color: #000088;">$base64</span> <span style="color: #339933;">=</span> <span style="color: #990000;">base64_encode</span><span style="color: #009900;">(</span><span style="color: #990000;">file_get_contents</span><span style="color: #009900;">(</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'src'</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>

            <span style="color: #000088;">$output</span> <span style="color: #339933;">.=</span> <span style="color: #0000ff;">'&lt;image overflow="visible" x="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">"x"</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" y="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">"y"</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" width="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">"width"</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" height="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">"height"</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" transform="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">"transform"</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" preserveAspectRatio="none" xlink:href="data:image/png;base64,'</span><span style="color: #339933;">.</span><span style="color: #000088;">$base64</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'"&gt;&lt;/image&gt;'</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">}</span>

        <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'type'</span><span style="color: #009900;">]</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">"path"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
            <span style="color: #000088;">$output</span> <span style="color: #339933;">.=</span> <span style="color: #0000ff;">'&lt;path fill="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'fill'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" stroke="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'stroke'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" d="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'path'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" style="opacity: '</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'opacity'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">';" opacity="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'opacity'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'" transform="'</span><span style="color: #339933;">.</span><span style="color: #000088;">$json</span><span style="color: #009900;">[</span><span style="color: #000088;">$i</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'transform'</span><span style="color: #009900;">]</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'"&gt;&lt;/path&gt;'</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">}</span>
    <span style="color: #009900;">}</span>

    <span style="color: #000088;">$output</span> <span style="color: #339933;">.=</span> <span style="color: #0000ff;">'&lt;/<strong>svg</strong>&gt;'</span><span style="color: #339933;">;</span></pre>
</div>
</div>
<h2>Save the <strong>SVG</strong> and send to Apache Batik for Rasterization</h2>
<p>So this part is fairly simple. I recommend using <a href="http://xmlgraphics.apache.org/batik/tools/rasterizer.html" target="_blank">Apache Batik</a> for the <strong>SVG</strong> rasterization as it seemed to have better results compared to ImageMagick. The first part is simply to write the ‘<strong>SVG</strong> string’ to a file.</p>
<div class="wp_syntax">
<div class="code">
<pre class="php" style="font-family: monospace;"><span style="color: #990000;">file_put_contents</span><span style="color: #009900;">(</span><span style="color: #0000ff;">'generated/avatar.<strong>svg</strong>'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$output</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
</div>
</div>
<p>Now, just send it across to Apache Batik with the exec() command, and we have a PNG!</p>
<div class="wp_syntax">
<div class="code">
<pre class="php" style="font-family: monospace;"><span style="color: #990000;">exec</span><span style="color: #009900;">(</span><span style="color: #0000ff;">"java -jar batik-rasterizer.jar /path/to/avatar.<strong>svg</strong>"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
</div>
</div>
<h2>Just the beginning</h2>
<p>So this was just a basic introduction to exporting an <strong>SVG</strong> from <strong>Raphael</strong>, and will need more work for more complex shapes and transformations. I’m planning on writing a RaphaelJS extension to make all this a bit easier, and perhaps offer out the server side code on a public domain so there’s no need to write it out…</p>
<p>So stay tuned. Or, if you’re already doing this, I’d be more than happy to help out.</p>
</body></html>
